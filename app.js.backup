// Data Management
class TracklyApp {
    constructor() {
        this.entities = this.loadFromStorage('entities') || [];
        this.entries = this.loadFromStorage('entries') || [];
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.renderEntities();
        this.renderEntries();
        this.populateEntitySelect();
        this.setDefaultTimestamp();
    }

    setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
        });

        // Entity form
        document.getElementById('entity-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.createEntity();
        });

        // Entry form
        document.getElementById('entry-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.createEntry();
        });
    }

    switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    createEntity() {
        const name = document.getElementById('entity-name').value.trim();
        const type = document.getElementById('entity-type').value;
        const unit = document.getElementById('entity-unit').value.trim();
        const target = document.getElementById('entity-target').value.trim();
        const frequency = document.getElementById('entity-frequency').value;
        const categoriesInput = document.getElementById('entity-categories').value;
        const categories = categoriesInput
            ? categoriesInput.split(',').map(c => c.trim()).filter(c => c)
            : [];

        // Check for duplicate name
        if (this.entities.some(e => e.name === name)) {
            alert('An entity with this name already exists!');
            return;
        }

        const entity = {
            id: this.generateId(),
            name,
            type,
            unit,
            target,
            frequency,
            categories,
            createdAt: new Date().toISOString()
        };

        this.entities.push(entity);
        this.saveToStorage('entities', this.entities);
        this.renderEntities();
        this.populateEntitySelect();

        // Reset form
        document.getElementById('entity-form').reset();

        alert(`Entity "${name}" created successfully!`);
    }

    deleteEntity(id) {
        if (!confirm('Are you sure you want to delete this entity? All related entries will also be deleted.')) {
            return;
        }

        this.entities = this.entities.filter(e => e.id !== id);
        this.entries = this.entries.filter(e => e.entityId !== id);

        this.saveToStorage('entities', this.entities);
        this.saveToStorage('entries', this.entries);

        this.renderEntities();
        this.renderEntries();
        this.populateEntitySelect();
    }

    renderEntities() {
        const container = document.getElementById('entities-list');

        if (this.entities.length === 0) {
            container.innerHTML = '<div class="empty-state">No entities yet. Create your first entity above!</div>';
            return;
        }

        container.innerHTML = this.entities
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .map(entity => `
                <div class="entity-card">
                    <h3>${this.escapeHtml(entity.name)}</h3>
                    <span class="entity-type ${entity.type.toLowerCase()}">${entity.type}</span>

                    <div class="entity-details">
                        <p><strong>Unit:</strong> ${this.escapeHtml(entity.unit)}</p>
                        ${entity.target ? `<p><strong>Target:</strong> ${this.escapeHtml(entity.target)}</p>` : ''}
                        <p><strong>Frequency:</strong> ${entity.frequency}</p>
                    </div>

                    ${entity.categories.length > 0 ? `
                        <div class="entity-categories">
                            ${entity.categories.map(cat => `<span class="category-tag">${this.escapeHtml(cat)}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="entity-actions">
                        <button class="btn btn-danger" onclick="app.deleteEntity('${entity.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
    }

    createEntry() {
        const entityId = document.getElementById('entry-entity').value;
        const value = document.getElementById('entry-value').value.trim();
        const timestamp = document.getElementById('entry-timestamp').value;
        const notes = document.getElementById('entry-notes').value.trim();

        const entity = this.entities.find(e => e.id === entityId);
        if (!entity) {
            alert('Please select a valid entity!');
            return;
        }

        const entry = {
            id: this.generateId(),
            entityId,
            entityName: entity.name,
            value,
            timestamp: new Date(timestamp).toISOString(),
            notes,
            createdAt: new Date().toISOString()
        };

        this.entries.push(entry);
        this.saveToStorage('entries', this.entries);
        this.renderEntries();

        // Reset form
        document.getElementById('entry-form').reset();
        this.setDefaultTimestamp();

        alert('Entry logged successfully!');
    }

    deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this entry?')) {
            return;
        }

        this.entries = this.entries.filter(e => e.id !== id);
        this.saveToStorage('entries', this.entries);
        this.renderEntries();
    }

    renderEntries() {
        const container = document.getElementById('entries-list');

        if (this.entries.length === 0) {
            container.innerHTML = '<div class="empty-state">No entries yet. Log your first entry above!</div>';
            return;
        }

        container.innerHTML = this.entries
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 20) // Show latest 20 entries
            .map(entry => `
                <div class="entry-card">
                    <div class="entry-header">
                        <span class="entry-entity-name">${this.escapeHtml(entry.entityName)}</span>
                        <span class="entry-timestamp">${this.formatDate(entry.timestamp)}</span>
                    </div>
                    <div class="entry-value">${this.escapeHtml(entry.value)}</div>
                    ${entry.notes ? `<div class="entry-notes">${this.escapeHtml(entry.notes)}</div>` : ''}
                    <div class="entity-actions" style="margin-top: 12px;">
                        <button class="btn btn-danger" onclick="app.deleteEntry('${entry.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
    }

    populateEntitySelect() {
        const select = document.getElementById('entry-entity');
        const currentValue = select.value;

        select.innerHTML = '<option value="">Select entity...</option>' +
            this.entities
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(entity => `<option value="${entity.id}">${this.escapeHtml(entity.name)} (${entity.type})</option>`)
                .join('');

        // Restore previous selection if still valid
        if (currentValue && this.entities.some(e => e.id === currentValue)) {
            select.value = currentValue;
        }
    }

    setDefaultTimestamp() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('entry-timestamp').value = now.toISOString().slice(0, 16);
    }

    // Utility functions
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    saveToStorage(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            console.error('Error saving to localStorage:', e);
            alert('Error saving data. Your browser may have storage limitations.');
        }
    }

    loadFromStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('Error loading from localStorage:', e);
            return null;
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (days === 0) {
            return 'Today, ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        } else if (days === 1) {
            return 'Yesterday, ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        } else if (days < 7) {
            return `${days} days ago`;
        } else {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }
}

// Initialize app
const app = new TracklyApp();
